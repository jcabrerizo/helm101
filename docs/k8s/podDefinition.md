# Pod definition

## Pod resource limits

* Cpu: Exceeding the limits throttle the container or the pod
* Memory: Exceeding can't be done, but requesting more force the pod to be evicted from the node
* Ephemeral storage: the scheduler selects a node with enough space for all the containers of a pod. The pod can be
  evicted if limit is reached

## Multi-container pods

### initContainers

The use of an initContainer allows one or more containers to run only if one or more previous containers run and exit
successfully

#### Simple pod with initializer

```yaml
apiVersion: v1
kind: Pod
metadata:
  creationTimestamp: null
  labels:
    run: composed
  name: composed
spec:
  containers:
  - image: nginx
    name: complex-pod
    ports:
    - containerPort: 80
  initContainers:
    - name: initializer 
      image: busybox
      command: ['/bin/sh', '-c', 'wget -O- google.com']
  dnsPolicy: ClusterFirst
  restartPolicy: Never
```

### Ambassador

This type of secondary container would be used to communicate with outside resources

### Adapter

This type of secondary container is useful to modify the data generated by the primary containe

### Sidecar

A sidecar is a secondary container which helps or provides a service not found in the primary application.

Check the logs:

```shell
POD_NAME=composed
INIT_CONTAINER_NAME=initializer
kubectl logs --previous $POD_NAME
kubectl logs $POD_NAME -c $INIT_CONTAINER_NAME
```

## Probes

* `readinessProbe`
* `livenessProbe`
* `startupProbe`

```yaml
apiVersion: v1
kind: Pod
metadata:
  creationTimestamp: null
  labels:
    run: web-server
  name: web-server
spec:
  containers:
  - image: nginx
    name: web-server
    ports:
    - containerPort: 80
      name: web
    startupProbe:
      httpGet:
        path: /
        port: web
    readinessProbe:
      exec:
        command:
          - sh
          - -c
          - cat /tmp/ready
      initialDelaySeconds: 5
      periodSeconds: 10
    livenessProbe:
      httpGet:
        path: /
        port: web
      periodSeconds: 30
      initialDelaySeconds: 10
  dnsPolicy: ClusterFirst
  restartPolicy: Always
status: {}
```

## Security context

https://kubernetes.io/docs/tasks/configure-pod-container/security-context/

Prevent `root` execution

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: nginx
spec:
  securityContext:
    runAsNonRoot: true
  containers:
  - image: nginx
    name: nginx
```

It could fail if the image tries to run as `root`
